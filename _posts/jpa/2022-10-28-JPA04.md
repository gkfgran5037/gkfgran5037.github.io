---
title:  "JPA 연관관계"
categories:
  - JPA
---

# 연관관계
- 테이블은 외래키 하나로 테이블 간 연관관계를 설정
- 연관관계의 ownership 결정 필요
  - ownership : 외래키를 관리하는 주체
  - RDB에서 외래키는 '다'쪽에 있음

## One-To-Many(Many-TO-One) 
1. @OneToMany 
  - Parent Entity(일) <- Child Entity(다)
  - @OneToMany(mappedBy = "자식 외래키 필드명")
  - 매핑된 필드 명시
  - 일대다 단반향으로만 연관관계를 매핑하면 안됨 = 양방향으로 매핑 필수

2. @ManyToOne
  - Child Entity(다) -> Parent Entity(일)
  - Child Entity가 Parent Entity의 PK를 가지는 구조 구현
  - @ManyToOne(fetch = FetchType.타입)
    - FetchType.LAZY : 연관된 엔티티는 가져오지 않음
    - FetchType.EAGER
      - 명시하지 않아도 연관된 엔티티도 함께 조회
      - Parent Entity에 Child Entity를 아우터 조인하여 조회
      - JPQL을 사용할 때 N+1문제가 발생 (쿼리 1개를 날리면서 추가적으로 N개의 쿼리가 나감)
  - @JoinColumn : FK로 사용되는 컬럼

<img width="575" alt="02_다대일" src="https://user-images.githubusercontent.com/42172353/197381091-a3ecedf5-4079-417b-a560-eed5c0cb3b9f.png">
<h5>[출처 - 스프링과 JPA를 이용한 웹개발] http://www.kocw.net/home/cview.do?cid=5e6aec4a9ae2dd45 </h5>
<br/><br/>


```java
@Entity
public class Item {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "ITEM_ID")
    private Long id;

    private String name;
    private int price;

    // FK 관리 주체 필드 (다 child)
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "PURCHASE_ORDER_ID")
    PurchaseOrder order;
}
```

<br/>

```java
@Entity
public class PurchaseOrder {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "PURCHASE_ORDER_ID")
    private long id;
    private String userName;

    // FK (일 parent)
    @OneToMany(mappedBy = "order")
    private List<Item> items = new ArrayList<Item>();
}
```

<br/>

```java
Item item1 = new Item();
item1.setName("치킨");
Item item2 = new Item();
item2.setName("치즈볼");

PurchaseOrder order = new PurchaseOrder();
order.setUserName("kim");
order.getItems().add(item1);
order.getItems().add(item2);

item1.setOrder(order);
item2.setOrder(order);

em.persist(order); // order(일) 먼저 할 경우 insert
em.persist(item1); // item(다) 먼저 할 경우 insert 후 update 처리됨
em.persist(item2);
```

<h5>[출처 - 스프링과 JPA를 이용한 웹개발] http://www.kocw.net/home/cview.do?cid=5e6aec4a9ae2dd45 </h5>
<br/><br/><br/>




## One-To-One
- Parent-Child 관계로 표현
- FK 위치 : Parent, Child 중 선택 지정 가능
     

<img width="80%" src="https://user-images.githubusercontent.com/42172353/197381092-3dc8deb3-f005-40ea-a083-ef323085dfeb.png">
<h5>[출처 - 스프링과 JPA를 이용한 웹개발] http://www.kocw.net/home/cview.do?cid=5e6aec4a9ae2dd45 </h5>




<br/><br/><br/>




## Many-To-Many

<img width="80%" src="https://user-images.githubusercontent.com/42172353/197381090-fdedd1e4-6d8e-49d7-aa0d-8ce36521c271.png">
<h5>[출처 - 스프링과 JPA를 이용한 웹개발] http://www.kocw.net/home/cview.do?cid=5e6aec4a9ae2dd45 </h5>
<br/><br/><br/>


<br/><br/><br/><br/><br/>
<h5>

[참고 강의 - 스프링과 JPA를 이용한 웹개발](http://www.kocw.net/home/cview.do?cid=5e6aec4a9ae2dd45)

</h5>


